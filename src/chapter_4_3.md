# 计算视线

&emsp;&emsp;根据前面的章节，光线生成的基础工具是视点（或用于平行投影的视向）和像平面。有很多方法可以解决相机几何细节的问题；在本节中，我们介绍一种基于正交基的方法，它支持正交投影、斜平行投影和正平行投影。

&emsp;&emsp;为了生成光线，我们首先需要光线的数学表示。一条光线实际上就是一个原点和一个传播方向；一条3D参数化直线是理想的选择。如章节2.7.7讨论的那样，从眼睛\\(\mathbf{e}\\)发出，穿过像平面上的点\\(\mathbf{s}\\)的3D参数化直线是：

\\[
\mathbf{p}=\mathbf{e}+t(\mathbf{s}-\mathbf{e})
\\]

&emsp;&emsp;这应该被翻译为，“我们从\\(\mathbf{e}\\)出发，沿着向量\\(\(\mathbf{s}-\mathbf{e}\)\\)走过分数距离\\(t\\)找到点\\(\mathbf{p}\\)。”所以给定\\(t\\)，我们能确定点\\(\mathbf{p}\\)。点\\(\mathbf{e}\\)是光线的起点，\\(\(\mathbf{s}-\mathbf{e}\)\\)是光线的方向。

&emsp;&emsp;注意到\\(\mathbf{p}\(0\)=\mathbf{e}\\)，\\(\mathbf{p}\(1\)=\mathbf{s}\\)，而且更一般地说，如果\\(0<t_{1}<t_{2}\\)，那么\\(\mathbf{p}\(t_{1}\)\\)比\\(\mathbf{p}\(t_{2}\)\\)更接近眼睛；而且，若\\(t<0\\)，则\\(\mathbf{p}\(t\)\\)位于眼睛“后面”。这些事实在我们研究被光线击中的最接近眼睛且不在眼睛后面的物体是哪个时特别有用。

&emsp;&emsp;在代码中，光线总是使用某种结构体或者对象来存储位置和方向。例如，在一个面向对象程序中，我们可以这样写：

```
class Ray
    Vec3 o | ray origin
    Vec3 d | ray direction
    Vec3 evalute(real t)
        return o + td
```

我们假定有一个叫Vec3的类，用来表示三维向量，同时支持常见的算数运算符。

&emsp;&emsp;为了计算一条视线，我们需要知道\\(\mathbf{e}\\)（给定的）和\\(\mathbf{s}\\)。寻找\\(\mathbf{s}\\)可能有些困难，但是如果我们在一个直角坐标系中看这个问题，结果十分直截了当。

![4.7](./img/4.7.png)

**图4.7：**屏幕上的采样点被映射到3D窗口上的类似阵列中。这些采样点的每一个位置都会发射一条视线。

我们的光线生成方法都是从正交坐标系（即相机坐标系，图4.7）开始的。我们将用\\(\mathbf{e}\\)表示眼睛点或视点，用\\(\mathbf{u}\\)，\\(\mathbf{v}\\)，\\(\mathbf{w}\\)表示三个基向量，同时令\\(\mathbf{u}\\)指向右（顺着相机视角），\\(\mathbf{v}\\)指向上，\\(\mathbf{w}\\)指向后面，因而\\(\lbrace \mathbf{u},\mathbf{v},\mathbf{w}\rbrace \\)构成右手坐标系。最常见的构建相机坐标系的方式就是令视点为\\(\mathbf{e}\\)，视方向为\\(-\mathbf{w}\\)，
